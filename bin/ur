#!/bin/bash
packages_file=${UR_PACKAGES_FILE:-./packages}
cache_dir=${UR_CACHE:-~/.ur}

mkdir -p "$cache_dir/log"
mkdir -p "$cache_dir/packages"

function main {
  local hostname=${UR_HOSTNAME:-0}
  local port=${UR_PORT:-8080}

  echo "starting server $hostname $port"

  tcpserver $hostname $port sh -c "$0 incoming_request"
}

function incoming_request {
  local in
  local method
  local url
  local version

  read -r method url version

  log_info "$method $url $version"

  local headers=$(read_headers)
  
  npm_handler $method $url
}

function redirect_handler {
  local location="$1"

  echo -e "HTTP/1.1 302 Found\r
Location: $location\r
\r"
}

function read_headers {
  local line

  while read -r line; do
    line=$(echo $line | tr -d '\r' | tr -d '\n')

    [[ -z "$line" ]] && break

    echo "$line"
  done
}

function npm_handler {
  local method=$1
  local url=$2
  local package=${url##/}

  package=${package%/*}

  local record=$(grep "^$package" "$packages_file")

  if [[ -z "$record" ]]; then
    redirect_handler "https://registry.npmjs.org$url"
  else
    load_package ${record#* }
  fi
}

function mirror_package {
  local git_url=$1
  local package_dir=$(echo "$git_url" | sha1sum | awk '{print $1}')
  
  if [[ ! -d "$cache_dir/packages/$package_dir" ]]; then
    mkdir -p "$cache_dir/packages/$package_dir"
    pushd "$cache_dir/packages/$package_dir" > /dev/null 2>&1
    git clone --mirror $git_url > /dev/null 2>&1
    popd > /dev/null 2>&1
  fi

  echo -n "$cache_dir/packages/$package_dir"
}

function log_info {
  echo $@
}

${1:-main} ${@:2}
